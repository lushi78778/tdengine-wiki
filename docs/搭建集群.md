# 搭建集群

> TDengine 采用虚拟节点技术，将一个节点虚拟化为多个虚拟节点，以实现负载均衡。

> TDengine可以将多个节点上的虚拟节点组成虚拟节点组，通过多副本机制，以保证供系统的高可用。

> 本文讲述使用 YAML 文件创建 TDengine 集群，与 Kubernetes 环境下 TDengine 的常用操作。

## 虚拟机搭建
虚拟化平台使用Hyper-V，参考网站：[Windows 10 上的 Hyper-V](https://learn.microsoft.com/zh-cn/virtualization/hyper-v-on-windows/)

### CentOS相关
镜像地址：https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/
```text
[root@172 yum.repos.d]# cat /etc/redhat-release
CentOS Linux release 7.9.2009 (Core)
```
### 修改yum源为阿里云yum源
```bash
# 备份原来的yum文件
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo_bak
# 下载阿里云的 CentOS-Base.repo 到/etc/yum.repos.d/
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
# 或
curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
# 清空原本yum缓存
yum clean all
# 生成新的阿里云的yum缓存，加速下载预热数据
yum makecache
```
### 时间同步
```bash
# 启动时间同步服务
systemctl start chronyd
# 开机启动时间同步
systemctl enable chronyd
```
### 防火墙
```bash
# kubernetes和docker会产生很多iptables规则，这些规则会和系统规则混淆，直接关闭系统规则
# 关闭防火墙
systemctl stop firewalld
# 禁用防火墙
systemctl disable firewalld
# centos6版本是iptables，centos7是firewalld
# 关闭防火墙
systemctl stop iptables
# 禁用防火墙
systemctl disable iptables
```
### 禁用SELINUX
```bash
# 编辑/etc/selinux/config文件，修改SELINUX的值为disabled
SELINUX=disabled
```
### 禁用swap
```bash
# 打开/etc/fstab，注释掉swap分区所在的行
# /dev/mapper/centos_172-swap swap                    swap    defaults        0 0
```
### 安装docker
```bash
yum install docker-ce
# 修改配置文件
mkdir /etc/docker

cat > /etc/docker/daemon.json <<EOF
{
    "exec-opts": ["native.cgroupdriver=systemd"],
    "registry-mirrors": ["https://kn0t2bca.mirror.aliyuncs.com"]
}
EOF

systemctl restart docker
systemctl enable docker
```
### 修改linux内核参数
```bash
# 添加网桥过滤和地址转发功能
# 编辑/etc/sysctl.d/kubernetes.conf文件，添加如下配置
net.bridge.bridge-nf-call-ip6tables =1
net.bridge.bridge-nf-call-iptables =1
net.ipv4.ip_forward = 1
#修改完后重新加载配置
sysctl -p
#加载网桥过滤模块
modprobe br_netfilter
#查看网桥过滤模块是否加载成功
lsmod | grep br_netfilter
```
### 配置ipvs功能
```bash
# 安装ipset和ipvsadm模块
yum install ipset ipvsadm -y

# 添加需要加载的模块写入脚本文件
cat > /etc/sysconfig/modules/ipvs.modules <<EOF
#! /bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF
# 为脚本文件添加执行权限
chmod +x /etc/sysconfig/modules/ipvs.modules
# 执行脚本文件
/bin/bash /etc/sysconfig/modules/ipvs.modules
# 查看对应的模块是否加载成功
lsmod | grep -e ip_vs -e nf_conntrack_ipv4
```
### 安装kubeadm、kubelet和kubectl
```bash
# 指定版本号
yum install --setopt=obsoletes=0 -y kubelet-1.18.17 kubeadm-1.18.17 kubectl-1.18.17
# 修改"/etc/sysconfig/kubelet"文件
KUBELET_CGROUP_ARGS="--cgroup-driver=systemd"
KUBE_PROXY_MODE="ipvs"
systemctl enable kubelet
```
### 准备集群镜像
```bash
# 所需镜像查看
kubeadm config images list
```

 > 我这里的<br>
 k8s.gcr.io/kube-apiserver:v1.18.17<br>
k8s.gcr.io/kube-controller-manager:v1.18.17<br>
k8s.gcr.io/kube-scheduler:v1.18.17<br>
k8s.gcr.io/kube-proxy:v1.18.17<br>
k8s.gcr.io/pause:3.2<br>
k8s.gcr.io/etcd:3.4.3-0<br>
k8s.gcr.io/coredns:1.6.7<br>
```
# 一起复制没问题的
docker pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.18.17
docker tag registry.aliyuncs.com/google_containers/kube-apiserver:v1.18.17 k8s.gcr.io/kube-apiserver:v1.18.17
docker rmi registry.aliyuncs.com/google_containers/kube-apiserver:v1.18.17

docker pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.18.17
docker tag registry.aliyuncs.com/google_containers/kube-controller-manager:v1.18.17 k8s.gcr.io/kube-controller-manager:v1.18.17
docker rmi registry.aliyuncs.com/google_containers/kube-controller-manager:v1.18.17

docker pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.18.17
docker tag registry.aliyuncs.com/google_containers/kube-scheduler:v1.18.17 k8s.gcr.io/kube-scheduler:v1.18.17
docker rmi registry.aliyuncs.com/google_containers/kube-scheduler:v1.18.17

docker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.18.17
docker tag registry.aliyuncs.com/google_containers/kube-proxy:v1.18.17 k8s.gcr.io/kube-proxy:v1.18.17
docker rmi registry.aliyuncs.com/google_containers/kube-proxy:v1.18.17

docker pull registry.aliyuncs.com/google_containers/pause:3.2
docker tag registry.aliyuncs.com/google_containers/pause:3.2 k8s.gcr.io/pause:3.2
docker rmi registry.aliyuncs.com/google_containers/pause:3.2

docker pull registry.aliyuncs.com/google_containers/etcd:3.4.3-0
docker tag registry.aliyuncs.com/google_containers/etcd:3.4.3-0 k8s.gcr.io/etcd:3.4.3-0
docker rmi registry.aliyuncs.com/google_containers/etcd:3.4.3-0

docker pull registry.aliyuncs.com/google_containers/coredns:1.6.7
docker tag registry.aliyuncs.com/google_containers/coredns:1.6.7 k8s.gcr.io/coredns:1.6.7
docker rmi registry.aliyuncs.com/google_containers/coredns:1.6.7
```
### ip静态化
#### 概述
Hyper-V自带一个不能删除的Default Switch虚拟交换机，虚拟机使用该网络可以自动获取IP直接上网。但这个网络的网关地址每次重启后都会改变，所以你无法在虚拟机上设置固定IP用于宿主机SSH访问。

微软说明：每次主机重启后Hyper-V会自动找一个未使用的网络然后修改Default Switch的网络地址。

方案是用虚拟机第一块网卡连接Default Switch自动获得IP和DNS上外网，用第二块网卡设置内部固定IP地址用于宿主机或其它虚拟机SSH连接。创建内部虚拟交换网络vEthernet (内部交换机)
#### 内部使用的虚拟交换机的地址
然后到Windows的“网络连接”里把vEthernet (内部交换机)的IP设为固定IP，比如192.168.3.1。这样设置也决定了192.168.3.x就是以后虚拟机的网段（网段需要按照实际情况设置）
#### 为虚拟机添加新网卡
在虚拟机上新增加一个网卡，加上原来的网卡，虚拟机就有两块网卡。然后将第一块网络适配器的虚拟交换机选为Default Switch，第二块选择前面新建的vEthernet (内部交换机)
#### 虚拟机内设置两块网卡的网络配置
配置eth0
虚拟机启动后编辑/etc/sysconfig/network-scripts/ifcfg-eth0，把BOOTPROTO改为dhcp，ONBOOT改为yes
```text
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="dhcp"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="eth0"
UUID="11faf1b5-2d11-4459-b85e-f8d1df00faeb"
DEVICE="eth0"
ONBOOT="yes"
```
配置eth1
如果创建虚拟机时就加了一个新网卡，则安装Centos后里面应该已经有/etc/sysconfig/network-scripts/ifcfg-eth1配置文件，如果是安装操作系统之后才新增网卡的，则可以通过以下命令从/etc/sysconfig/network-scripts/ifcfg-eth0拷贝一份修改：
```bash
cp /etc/sysconfig/network-scripts/ifcfg-eth0 /etc/sysconfig/network-scripts/ifcfg-eth1
```
修改重点是把BOOTPROTO设成static；把NAME和DEVICE改为eth1；ONBOOT还是yes；记得删除UUID那行（不能和eth0相同）。最后就是加上IPADDR=192.168.3.2和NETMASK=255.255.255.0（注意：IP必须与vEthernet (内部交换机)一个网段，不需要设置GATEWAY）
```text
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="static"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="eth1"
DEVICE="eth1"
ONBOOT="yes"
IPADDR=192.168.3.2
NETMASK=255.255.255.0
```
#### 重启网络
```bash
/etc/init.d/network restart 	
```

### 多开虚拟机
Hyper-V快速克隆创建虚拟机，先导出后导入。导入虚拟机时，记得选择复制虚拟机
```bash
# 改ip参数
vim /etc/sysconfig/network-scripts/ifcfg-eth1
# 改主机名字
sudo hostnamectl set-hostname master
```
没事加个检查点，别玩砸了~